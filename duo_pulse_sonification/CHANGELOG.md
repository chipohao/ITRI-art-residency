# Duo Pulse - Changelog

所有對此專案的重要修改與版本迭代紀錄將保存在此文件中。

## [v2.0_playground] - 2026-02-28
### ✨ 大幅升級 (Major Update)
- **全面更換核心演算法**：導入官方 `PulseSensorPlayground` 開源函式庫，取代原本手工撰寫的追蹤演算法。
- **引入高階濾波**：內建官方硬體級與數學級降噪過濾、Derivative 斜率波峰運算，大幅提升對劣質訊號的容錯力，且不需要按壓感測器即可穩定讀出心跳。
- **加入 UART 節流機制 (Throttling)**：由於官方函式庫預設運作頻率高達 `500Hz`（每秒 500 次），若全部經由 UART 或是 WiFi OSC 發送會造成嚴重壅塞。新增 `now - lastRawTime >= 10` 機制，將 RAW 輸出限制在 `100Hz`（每 10 毫秒一筆），既能維持流暢波形也不會導致當機。
- **心跳視覺化閉口 (Simulated Gate)**：官方函式庫僅提供「波峰觸發 (sawStartOfBeat)」。在此版將每次心跳加上了 200ms 的延遲關門訊號（`/beat 0`），確保在 MaxMSP 端有明確的 ON/OFF 開關。

---

## [v1.1_stable] - 2026-02-28
### ✨ 新增 (Added)
- **手指偵測自動化 (`fingerOn` 機制)**：
  - 感測到手指放上時，立刻傳送單次 `/finger 1`（OSC及Serial）。
  - 感測到手指移開時，立刻傳送單次 `/finger 0`，然後停止傳送心跳資訊。
- **波峰捕捉狀態機 (`beatArmed` 機制)**：
  - 波形必須跌回平均值 (currentThreshold) 以下，系統才會重新「武裝」準備抓取下一次心跳，防止一個較平緩的波峰被連續觸發成兩次心跳。

### 🔧 變更與優化 (Changed)
- **超穩定心跳偵測演算法 (Refractory & Debounce)**：
  - 借鏡了 `pulse_gyro` 的單次觸發機制的優點，融合進我們原有的「動態閥值 (Adaptive Threshold)」中。
  - **心跳發光鎖死**：一旦偵測到心跳穿過閥值，強制鎖死 ON 狀態 200 毫秒，期間無視任何雜訊震動。
  - **冷卻時間 (CD Time)**：兩次心跳的間隔強制設定大於 300 毫秒（相當於最高限制於 200 BPM），以過濾手部輕微抖動。
- **改善動態範圍追蹤**：
  - 遲滯區間比例調整為振幅幅度的 1/4（`amplitude / 4`），要求訊號爬升得更高才算有效跳動，避免被小雜訊干擾。

---

## [v1.0] - 初始版本
### ✨ 特色
- 支援雙路 Pulse Sensor 感測（Sensor A / Sensor B）。
- 最高 12-bit (0-4095) 分析解析度，以指數平滑濾除背景高頻雜訊。
- 自動向上的波浪動態閥值演算法。
- 支援 OSC over WiFi 傳送 `/pulse/userA/beat` 等資料到 MaxMSP。
